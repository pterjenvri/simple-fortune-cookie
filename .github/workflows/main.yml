name: Main workflow
on: 
  push:
     branches:
      - main
  pull_request:
     branches:
      - main
env:
  docker_username: nima-moayedzadeh
  docker_password: ${{ secrets.GITHUB_TOKEN }}
  GIT_COMMIT: ${{ github.sha }}
jobs:
    Build:
      runs-on: ubuntu-latest
      container: golang:1.25.0-bookworm
      steps:
        - name: Clone down repository
          uses: actions/checkout@v5
        - name: Build backend
          run: |
            cd backend
            go build -buildvcs=false
        - name: Build frontend
          run: |
            cd frontend
            go build -buildvcs=false
        - name: Run test
          run: | 
            cd frontend
            go test
    Test-application: 
      runs-on: ubuntu-latest
      needs: [Build]
      steps:
        - name: Clone down repository
          uses: actions/checkout@v5
        - name: Set up Docker Compose
          uses: docker/setup-compose-action@v1  
        - name: start application
          run:  docker compose up -d
        - name: wait
          run:  sleep 5
        - name: run test
          run:  cd test && test.sh http://localhost:8080
        - name: stop container
          if:   always()
          run:  docker compose down
    Docker-build-and-push:
        runs-on: ubuntu-latest
        needs: [Test-application]
        permissions:
          packages: write
        steps:
          - name: Clone down repository
            uses: actions/checkout@v5
          - name: Login to DockerHub
            uses: docker/login-action@v3
            with:
              registry: ghcr.io
              username: ${{ github.actor }}
              password: ${{ secrets.GITHUB_TOKEN }}
          - name: Build and push frontend
            uses: docker/build-push-action@v5
            with:
              context: ./frontend
              push: true
              tags: ghcr.io/pterjenvri/cookie-frontend:latest
          - name: Build and push backend
            uses: docker/build-push-action@v5
            with:
              context: ./backend
              push: true
              tags: ghcr.io/pterjenvri/cookie-backend:latest
          
    Deploy-application:
        runs-on: ubuntu-latest
        needs: [Test-application]
        steps:
            - name: Clone down repository
              uses: actions/checkout@v5
            - name: Deploy app
              run: |
                cd deployment
                echo "${{ secrets.KUBECONFIG }}" > kubeconfig
                kubectl --kubeconfig kubeconfig apply -f .
          
      

    
